<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="infrastructures_title">Infraestructuras - GESTOR DE MANTENIMIENTO PREVENTIVO</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/infraestructuras.css">
    <link rel="stylesheet" href="../css/dark-theme.css">
</head>
<body>
    <!-- Header Navigation -->
    <header class="main-header" role="banner">
        <nav class="navbar" role="navigation" aria-label="Navegaci√≥n principal">
            <div class="nav-container">
                <!-- Logo -->
                <div class="nav-logo">
                    <a href="dashboard.html" class="logo-link" aria-label="Ir al inicio">
                        <span class="logo-text">GMPI</span>
                        <span class="logo-subtitle" data-translate="school_maintenance">Mantenimiento Escolar</span>
                    </a>
                </div>

                <!-- Navigation Menu -->
                <ul class="nav-menu" role="menubar">
                    <li class="nav-item dropdown" role="none">
                        <a href="#" class="nav-link" role="menuitem" aria-haspopup="true" aria-expanded="false" tabindex="0">
                            <span class="icon">üìä</span>
                            <span data-translate="management">Gesti√≥n</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </a>
                        <div class="dropdown-content" role="menu" aria-label="Opciones de Gesti√≥n">
                            <a href="dashboard.html" role="menuitem" tabindex="-1">
                                <span class="icon">üè†</span>
                                <span data-translate="dashboard">Dashboard</span>
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown" role="none">
                        <a href="#" class="nav-link" role="menuitem" aria-haspopup="true" aria-expanded="false" tabindex="0">
                            <span class="icon">üìã</span>
                            <span data-translate="planning">Planificaci√≥n</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </a>
                        <div class="dropdown-content" role="menu" aria-label="Opciones de Planificaci√≥n">
                            <a href="#" id="calendarLink" role="menuitem" tabindex="-1">
                                <span class="icon">üìÖ</span>
                                <span data-translate="calendar">Calendario</span>
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown" role="none">
                        <a href="#" class="nav-link" role="menuitem" aria-haspopup="true" aria-expanded="false" tabindex="0">
                            <span class="icon">‚öôÔ∏è</span>
                            <span data-translate="configuration">Configuraci√≥n</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </a>
                        <div class="dropdown-content" role="menu" aria-label="Opciones de Configuraci√≥n">
                            <a href="#" role="menuitem" tabindex="-1" id="languageToggle">
                                <span class="icon">üåê</span>
                                <span data-translate="language">Idioma</span>
                                <span class="setting-value" id="currentLanguage">ES</span>
                            </a>
                            <a href="#" role="menuitem" tabindex="-1" id="themeToggle">
                                <span class="icon">üåì</span>
                                <span data-translate="theme">Tema</span>
                                <span class="setting-value" id="currentTheme">‚òÄÔ∏è</span>
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown" role="none">
                        <a href="#" class="nav-link" role="menuitem" aria-haspopup="true" aria-expanded="false" tabindex="0">
                            <span class="icon">‚ùì</span>
                            <span data-translate="help">Ayuda</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </a>
                        <div class="dropdown-content" role="menu" aria-label="Opciones de Ayuda">
                            <a href="contact.html" role="menuitem" tabindex="-1">
                                <span class="icon">üìß</span>
                                <span data-translate="contact">Contacto</span>
                            </a>
                            <a href="#" role="menuitem" tabindex="-1" id="keyboardShortcuts">
                                <span class="icon">‚å®Ô∏è</span>
                                <span data-translate="shortcuts">Atajos de Teclado</span>
                            </a>
                        </div>
                    </li>
                </ul>

                <!-- Action Buttons -->
                <div class="nav-actions">
                    <span class="user-welcome" data-translate="welcome">Bienvenido, Inspector</span>
                    <a href="index.html" class="btn btn-secondary" data-translate="logout">Cerrar Sesi√≥n</a>
                </div>

                <!-- Mobile Menu Toggle -->
                <div class="mobile-menu-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content" role="main">
        <!-- Page Header -->
        <section class="page-header">
        <div class="container">
            <div class="header-content">
                <h1 class="page-title" data-translate="registered_infrastructures">Infraestructuras Registradas</h1>
                <p class="page-subtitle" data-translate="infrastructure_subtitle">Gestiona y supervisa todas las instituciones educativas del sistema</p>
            </div>
        </div>
    </section>

    <!-- Barra de B√∫squeda R√°pida -->
    <section class="search-section">
        <div class="container">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" 
                           id="searchInfrastructures" 
                           class="search-input" 
                           placeholder="Buscar infraestructuras..." 
                           aria-label="Buscar infraestructuras">
                    <button class="search-btn" id="searchBtn" aria-label="Buscar">
                        <span class="search-icon">üîç</span>
                    </button>
                    <button class="clear-btn" id="clearSearch" aria-label="Limpiar b√∫squeda" style="display: none;">
                        <span class="clear-icon">‚úï</span>
                    </button>
                </div>
                <div class="search-results-count" id="searchResultsCount"></div>
                
                <!-- Filtros de b√∫squeda -->
                <div class="search-filters">
                    <label for="typeFilter">Filtrar por tipo:</label>
                    <select id="typeFilter" class="filter-select">
                        <option value="">Todos los tipos</option>
                        <option value="escuela">Escuela</option>
                        <option value="colegio">Colegio</option>
                        <option value="universidad">Universidad</option>
                    </select>
                </div>
            </div>
        </div>
    </section>

            <!-- Institutions Grid -->
            <div class="institutions-section">
                <div class="section-header">
                    <h2 data-translate="educational_institutions">Instituciones Educativas</h2>
                    <button class="btn btn-primary add-institution-btn">
                        <span data-translate="add_institution">+ Agregar Instituci√≥n</span>
                    </button>
                </div>

                <div class="institutions-grid">
                    <!-- Las instituciones aparecer√°n aqu√≠ din√°micamente -->
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="../javascript/route-manager.js"></script>
    <script type="module" src="../javascript/supabase-config.js"></script>
    <script src="../javascript/institutions-supabase.js"></script>
    <script>
        // Simple interactivity
        document.addEventListener('DOMContentLoaded', async function() {
            // Cargar instituciones desde Supabase
            await loadDynamicInstitutions();

            const addButton = document.querySelector('.add-institution-btn');
            addButton.addEventListener('click', function() {
                window.location.href = 'add-institution.html';
            });
        });
        
        // Funciones globales para manejar instituciones - CORREGIDAS
        window.viewInstitutionDetails = function(id) {
            console.log('üëÅÔ∏è Ver detalles de instituci√≥n:', id);
            window.location.href = `institution-details.html?id=${id}`;
        };

        window.editInstitution = function(id) {
            console.log('‚úèÔ∏è Editar instituci√≥n:', id);
            window.location.href = `edit-institution.html?id=${id}`;
        };

        window.deleteInstitutionConfirm = async function(id) {
            try {
                const institution = await window.institutionsManager.getInstitutionById(id);
                
                if (!institution) {
                    alert('Error: No se encontr√≥ la instituci√≥n');
                    return;
                }

                const confirmMessage = `¬øEst√°s seguro de que quieres eliminar la instituci√≥n "${institution.name}"?\n\nEsta acci√≥n no se puede deshacer.`;
                
                if (confirm(confirmMessage)) {
                    const card = document.querySelector(`[data-institution-id="${id}"]`);
                    if (card) {
                        card.style.opacity = '0.5';
                        card.style.pointerEvents = 'none';
                    }
                    
                    await window.institutionsManager.deleteInstitution(id);
                    
                    if (card) {
                        card.style.transform = 'scale(0.8)';
                        card.style.opacity = '0';
                        setTimeout(() => {
                            card.remove();
                            showSuccessMessage('‚úÖ Instituci√≥n eliminada exitosamente');
                        }, 300);
                    }
                }
            } catch (error) {
                console.error('Error al eliminar instituci√≥n:', error);
                alert('Error al eliminar la instituci√≥n. Por favor, int√©ntalo de nuevo.');
                
                const card = document.querySelector(`[data-institution-id="${id}"]`);
                if (card) {
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }
            }
        };

        // Funci√≥n para mostrar mensajes de √©xito
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 1rem 2rem;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                font-weight: 500;
            `;

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    messageDiv.remove();
                }, 300);
            }, 3000);
        }
        
        // Funci√≥n para cargar instituciones desde Supabase
        async function loadDynamicInstitutions() {
            const institutionsGrid = document.querySelector('.institutions-grid');
            
            try {
                institutionsGrid.innerHTML = '<div class="loading-message">üîÑ Cargando instituciones...</div>';
                
                if (!window.institutionsManager) {
                    let attempts = 0;
                    while (!window.institutionsManager && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                }
                
                if (!window.institutionsManager) {
                    throw new Error('El gestor de instituciones no est√° disponible');
                }
                
                const institutions = await window.institutionsManager.loadInstitutions();
                console.log('üè´ Instituciones cargadas desde Supabase:', institutions);
                
                institutionsGrid.innerHTML = '';
                
                if (institutions.length === 0) {
                    institutionsGrid.innerHTML = `
                        <div class="empty-message">
                            <h3>üìö No hay instituciones registradas</h3>
                            <p>Agrega tu primera instituci√≥n educativa.</p>
                        </div>
                    `;
                    return;
                }
                
                institutions.forEach(institution => {
                    const institutionCard = createInstitutionCard(institution);
                    institutionsGrid.appendChild(institutionCard);
                });
                
                // Actualizar contador de b√∫squeda despu√©s de cargar
                setTimeout(() => {
                    const searchResultsCount = document.getElementById('searchResultsCount');
                    if (searchResultsCount) {
                        searchResultsCount.textContent = `Mostrando ${institutions.length} infraestructuras`;
                    }
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error al cargar instituciones:', error);
                institutionsGrid.innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Error al cargar instituciones</h3>
                        <p>Error: ${error.message}</p>
                        <button onclick="loadDynamicInstitutions()" class="btn-retry">üîÑ Intentar de nuevo</button>
                    </div>
                `;
            }
        }
        
        // Funci√≥n para crear una tarjeta de instituci√≥n - CORREGIDA
        function createInstitutionCard(institution) {
            const card = document.createElement('div');
            card.className = 'institution-card';
            card.setAttribute('data-institution-id', institution.id);
            
            const typeEmoji = {
                'universidad': 'üéì',
                'colegio': 'üè´',
                'escuela': 'üè†',
                'instituto': 'üè¢'
            };

            // Formatear fechas CORRECTAMENTE
            const formatDate = (dateString) => {
                if (!dateString || dateString === null || dateString === 'null') {
                    return 'Sin registrar';
                }
                
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return 'Fecha inv√°lida';
                    }
                    
                    return date.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (error) {
                    console.error('Error al formatear fecha:', error);
                    return 'Error en fecha';
                }
            };

            const acronym = institution.acronym || 
                institution.name.split(' ')
                    .map(word => word.charAt(0).toUpperCase())
                    .join('')
                    .substring(0, 4) || 'INST';
            
            card.innerHTML = `
                <div class="institution-header">
                    <div class="institution-logo ${(institution.type || 'instituto').toLowerCase()}">
                        <span class="logo-text">${acronym}</span>
                    </div>
                </div>
                
                <div class="institution-info">
                    <h3 class="institution-name">${institution.name || 'Sin nombre'}</h3>
                    <p class="institution-location">üìç ${institution.location || 'Sin ubicaci√≥n'}</p>
                    <p class="institution-type">${typeEmoji[(institution.type || 'instituto').toLowerCase()] || 'üèõÔ∏è'} ${(institution.type || 'Instituto').charAt(0).toUpperCase() + (institution.type || 'instituto').slice(1)}</p>
                </div>
                
                <div class="institution-details">
                    <div class="detail-row">
                        <span class="detail-label">üè¢ Edificios:</span>
                        <span class="detail-value">${institution.buildings || 1}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üè´ Aulas:</span>
                        <span class="detail-value">${institution.classrooms || 1}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üî¨ Laboratorios:</span>
                        <span class="detail-value">${institution.laboratories || 0}</span>
                    </div>
                </div>
                
                <div class="maintenance-info">
                    <div class="maintenance-row">
                        <span class="maintenance-label">üîß √öltimo mantenimiento:</span>
                        <span class="maintenance-date">${formatDate(institution.last_maintenance)}</span>
                    </div>
                    <div class="maintenance-row">
                        <span class="maintenance-label">üìÖ Pr√≥ximo mantenimiento:</span>
                        <span class="maintenance-date next">${formatDate(institution.next_maintenance)}</span>
                    </div>
                </div>
                
                <div class="institution-actions">
                    <button class="btn btn-secondary btn-small" onclick="viewInstitutionDetails('${institution.id}')" title="Ver informaci√≥n completa">
                        <span class="btn-icon">üëÅÔ∏è</span>
                        <span class="btn-text">Ver Detalles</span>
                    </button>
                    <button class="btn btn-primary btn-small" onclick="editInstitution('${institution.id}')" title="Editar informaci√≥n de la instituci√≥n">
                        <span class="btn-icon">‚úèÔ∏è</span>
                        <span class="btn-text">Gestionar-Editar</span>
                    </button>
                    <button class="btn btn-outline btn-small" onclick="deleteInstitutionConfirm('${institution.id}')" title="Eliminar instituci√≥n permanentemente">
                        <span class="btn-icon">üóëÔ∏è</span>
                        <span class="btn-text">Eliminar</span>
                    </button>
                </div>
            `;
            
            return card;
        }
    </script>
    
    <!-- Script de B√∫squeda de Infraestructuras - CORREGIDO -->
    <script>
        // Variables globales para la b√∫squeda
        let searchInput, typeFilter, clearBtn, searchResultsCount;
        let currentSearchTerm = '';
        let currentFilter = '';

        // Funci√≥n para obtener las tarjetas din√°micamente
        function getInstitutionCards() {
            return document.querySelectorAll('.institution-card');
        }

        // Funci√≥n de b√∫squeda y filtrado - CORREGIDA
        function performSearch() {
            const institutionCards = getInstitutionCards();
            let visibleCount = 0;
            const query = currentSearchTerm.toLowerCase().trim();
            const typeFilterValue = currentFilter.toLowerCase();
            
            console.log('üîç Realizando b√∫squeda:', { query, typeFilterValue, totalCards: institutionCards.length });
            
            institutionCards.forEach(card => {
                const institutionName = card.querySelector('.institution-name')?.textContent.toLowerCase() || '';
                const institutionLocation = card.querySelector('.institution-location')?.textContent.toLowerCase() || '';
                const institutionType = card.querySelector('.institution-type')?.textContent.toLowerCase() || '';
                
                const matchesSearch = query === '' || 
                                    institutionName.includes(query) || 
                                    institutionLocation.includes(query) || 
                                    institutionType.includes(query);
                
                const matchesFilter = typeFilterValue === '' || institutionType.includes(typeFilterValue);
                
                if (matchesSearch && matchesFilter) {
                    card.style.display = 'block';
                    card.classList.remove('hidden');
                    card.classList.add('search-match');
                    visibleCount++;
                    
                    setTimeout(() => {
                        card.classList.remove('search-match');
                    }, 300);
                } else {
                    card.style.display = 'none';
                    card.classList.add('hidden');
                    card.classList.remove('search-match');
                }
            });
            
            console.log('‚úÖ B√∫squeda completada:', { visibleCount });
            updateSearchResults(query, visibleCount, institutionCards.length);
            
            if (clearBtn) {
                clearBtn.style.display = (query || typeFilterValue) ? 'flex' : 'none';
            }
        }
        
        // Actualizar contador de resultados
        function updateSearchResults(query, count, total) {
            if (!searchResultsCount) return;
            
            let message = '';
            if (query === '' && currentFilter === '') {
                message = `Mostrando ${total} infraestructuras`;
            } else {
                const plural = count === 1 ? 'infraestructura' : 'infraestructuras';
                let searchInfo = '';
                if (query) searchInfo += `"${query}"`;
                if (currentFilter) {
                    if (searchInfo) searchInfo += ' y ';
                    searchInfo += `tipo "${currentFilter}"`;
                }
                message = `${count} ${plural} encontradas para ${searchInfo}`;
            }
            searchResultsCount.textContent = message;
        }

        // Funci√≥n para inicializar la b√∫squeda
        function initializeSearch() {
            searchInput = document.getElementById('searchInfrastructures');
            typeFilter = document.getElementById('typeFilter');
            clearBtn = document.getElementById('clearSearch');
            searchResultsCount = document.getElementById('searchResultsCount');
            
            if (!searchInput) {
                console.log('‚ùå No se encontraron elementos de b√∫squeda');
                return;
            }
            
            console.log('üîß Inicializando b√∫squeda...');
            
            // Event listeners
            searchInput.addEventListener('input', function() {
                currentSearchTerm = this.value;
                performSearch();
            });
            
            if (typeFilter) {
                typeFilter.addEventListener('change', function() {
                    currentFilter = this.value;
                    performSearch();
                });
            }
            
            // Enter para ejecutar b√∫squeda Y LIMPIAR CAMPO
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = this.value.trim();
                    if (searchTerm !== '') {
                        console.log('üîç Ejecutando b√∫squeda para:', searchTerm);
                        currentSearchTerm = searchTerm;
                        performSearch();
                        // LIMPIAR EL CAMPO despu√©s de la b√∫squeda
                        this.value = '';
                        this.placeholder = `B√∫squeda: "${searchTerm}" - Escribe para filtrar m√°s`;
                        
                        setTimeout(() => {
                            this.placeholder = 'Buscar infraestructuras...';
                        }, 4000);
                    }
                }
            });
            
            // Limpiar b√∫squeda y filtros
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    if (typeFilter) typeFilter.value = '';
                    currentSearchTerm = '';
                    currentFilter = '';
                    performSearch();
                    searchInput.focus();
                });
            }
            
            // Atajo de teclado Ctrl+K para enfocar la b√∫squeda
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }
            });
            
            console.log('‚úÖ B√∫squeda inicializada correctamente');
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeSearch, 100);
            
            const institutionsGrid = document.querySelector('.institutions-grid');
            if (institutionsGrid) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.addedNodes.length > 0) {
                            setTimeout(() => {
                                const cards = getInstitutionCards();
                                if (cards.length > 0) {
                                    console.log('üîÑ Tarjetas cargadas, actualizando b√∫squeda...');
                                    updateSearchResults('', cards.length, cards.length);
                                }
                            }, 100);
                        }
                    });
                });
                
                observer.observe(institutionsGrid, { childList: true });
            }
        });
    </script>
    
    <script src="../javascript/navigation.js"></script>
    <script src="../javascript/settings.js"></script>
    
    <script>
        // Funcionalidad del calendario
        document.addEventListener('DOMContentLoaded', function() {
            const calendarLink = document.getElementById('calendarLink');
            
            if (calendarLink) {
                calendarLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = 'calendario.html';
                });
            }
        });
    </script>
    
    <script>
        // Initialize settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof SettingsManager !== 'undefined') {
                const settingsManager = new SettingsManager();
                
                const languageToggle = document.getElementById('languageSwitch');
                const themeToggle = document.getElementById('themeSwitch');
                const keyboardShortcuts = document.getElementById('keyboardShortcuts');
                
                if (languageToggle) {
                    languageToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        settingsManager.toggleLanguage();
                    });
                }
                
                if (themeToggle) {
                    themeToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        settingsManager.toggleTheme();
                    });
                }
                
                if (keyboardShortcuts) {
                    keyboardShortcuts.addEventListener('click', function(e) {
                        e.preventDefault();
                        settingsManager.showShortcuts();
                    });
                }
            }
        });
    </script>
</body>
</html>
